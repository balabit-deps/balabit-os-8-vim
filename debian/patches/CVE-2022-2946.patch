From adce965162dd89bf29ee0e5baf53652e7515762c Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 22 Aug 2022 16:35:45 +0100
Subject: [PATCH] patch 9.0.0246: using freed memory when 'tagfunc' deletes the
 buffer

Problem:    Using freed memory when 'tagfunc' deletes the buffer.
Solution:   Make a copy of the tag name.
---
 src/tag.c                    |  9 ++++++++-
 src/testdir/test_tagfunc.vim | 12 ++++++++++++
 src/version.c                |  2 ++
 3 files changed, 22 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/tag.c
+++ vim-8.1.2269/src/tag.c
@@ -161,6 +161,8 @@ do_tag(
 						       priority computation */
     int         use_tfu = 1;
 
+    char_u *tofree = NULL;
+
     /* remember the matches for the last used tag */
     static int		num_matches = 0;
     static int		max_num_matches = 0;  /* limit used for match search */
@@ -510,7 +512,12 @@ do_tag(
 	 * When desired match not found yet, try to find it (and others).
 	 */
 	if (use_tagstack)
-	    name = tagstack[tagstackidx].tagname;
+	{
+	    // make a copy, the tagstack may change in 'tagfunc'
+	    name = vim_strsave(tagstack[tagstackidx].tagname);
+	    vim_free(tofree);
+	    tofree = name;
+	}
 #if defined(FEAT_QUICKFIX)
 	else if (g_do_tagpreview != 0)
 	    name = ptag_entry.tagname;
@@ -802,6 +809,7 @@ end_do_tag:
     g_do_tagpreview = 0;	/* don't do tag preview next time */
 # endif
 
+    vim_free(tofree);
 #ifdef FEAT_CSCOPE
     return jumped_to_tag;
 #else
