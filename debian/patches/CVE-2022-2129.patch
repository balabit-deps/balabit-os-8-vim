From d6211a52ab9f53b82f884561ed43d2fe4d24ff7d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sat, 18 Jun 2022 19:48:14 +0100
Subject: [PATCH] patch 8.2.5126: substitute may overrun destination buffer

Problem:    Substitute may overrun destination buffer.
Solution:   Disallow switching buffers in a substitute expression.
---
 src/ex_docmd.c                  |  7 ++++---
 src/testdir/test_substitute.vim | 13 +++++++++++++
 src/version.c                   |  2 ++
 3 files changed, 19 insertions(+), 3 deletions(-)

--- vim-8.1.2269.orig/src/ex_docmd.c
+++ vim-8.1.2269/src/ex_docmd.c
@@ -6151,7 +6151,7 @@ do_exedit(
     {
 	/* Can't edit another file when "curbuf_lock" is set.  Only ":edit"
 	 * can bring us here, others are stopped earlier. */
-	if (*eap->arg != NUL && curbuf_locked())
+	if (*eap->arg != NUL && text_or_buf_locked())
 	    return;
 
 	n = readonlymode;
--- vim-8.1.2269.orig/src/testdir/test_substitute.vim
+++ vim-8.1.2269/src/testdir/test_substitute.vim
@@ -742,3 +742,16 @@ func Test_using_old_sub()
   bwipe!
   set nocompatible
 endfunc
+
+" This was editing a script file from the expression
+func Test_sub_edit_scriptfile()
+  new
+  norm o0000000000000000000000000000000000000000000000000000
+  func EditScript()
+    silent! scr! Xfile
+  endfunc
+  s/\%')/\=EditScript()
+
+  delfunc EditScript
+  bwipe!
+endfunc
