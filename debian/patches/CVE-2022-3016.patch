From 6d24a51b94beb1991cddce221f90b455e2d50db7 Mon Sep 17 00:00:00 2001
From: Yegappan Lakshmanan <yegappan@yahoo.com>
Date: Sat, 27 Aug 2022 20:59:57 +0100
Subject: [PATCH] patch 9.0.0286: using freed memory when location list changed
 in autocmd

Problem:    Using freed memory when location list changed in autocmd.
Solution:   Return QF_ABORT and handle it. (Yegappan Lakshmanan,
            closes #10993)
---
 src/quickfix.c                | 28 ++++++++++++++++++----------
 src/testdir/test_quickfix.vim | 17 +++++++++++++++++
 src/version.c                 |  2 ++
 3 files changed, 37 insertions(+), 10 deletions(-)

--- vim-8.1.2269.orig/src/quickfix.c
+++ vim-8.1.2269/src/quickfix.c
@@ -582,6 +582,7 @@ enum {
     QF_NOMEM = 3,
     QF_IGNORE_LINE = 4,
     QF_MULTISCAN = 5,
+    QF_ABORT = 6
 };
 
 /*
@@ -3097,7 +3098,7 @@ qf_jump_to_usable_window(int qf_fnum, in
 /*
  * Edit the selected file or help file.
  * Returns OK if successfully edited the file, FAIL on failing to open the
- * buffer and NOTDONE if the quickfix/location list was freed by an autocmd
+ * buffer and QF_ABORT if the quickfix/location list was freed by an autocmd
  * when opening the buffer.
  */
     static int
@@ -3141,14 +3142,14 @@ qf_jump_edit_buffer(
 	{
 	    emsg(_("E924: Current window was closed"));
 	    *opened_window = FALSE;
-	    return NOTDONE;
+	    return QF_ABORT;
 	}
     }
 
     if (qfl_type == QFLT_QUICKFIX && !qflist_valid(NULL, save_qfid))
     {
 	emsg(_("E925: Current quickfix was changed"));
-	return NOTDONE;
+	return QF_ABORT;
     }
 
     if (old_qf_curlist != qi->qf_curlist
@@ -3158,7 +3159,7 @@ qf_jump_edit_buffer(
 	    emsg(_("E925: Current quickfix was changed"));
 	else
 	    emsg(_(e_loc_list_changed));
-	return NOTDONE;
+	return QF_ABORT;
     }
 
     return retval;
@@ -3420,12 +3421,18 @@ qf_jump_newwin(qf_info_T	*qi,
     retval = qf_jump_open_window(qi, qf_ptr, newwin, &opened_window);
     if (retval == FAIL)
 	goto failed;
+    if (retval == QF_ABORT)
+    {
+	qi = NULL;
+	qf_ptr = NULL;
+	goto theend;
+    }
     if (retval == NOTDONE)
 	goto theend;
 
     retval = qf_jump_to_buffer(qi, qf_index, qf_ptr, forceit, prev_winid,
 				  &opened_window, old_KeyTyped, print_message);
-    if (retval == NOTDONE)
+    if (retval == QF_ABORT)
     {
 	// Quickfix/location list is freed by an autocmd
 	qi = NULL;
