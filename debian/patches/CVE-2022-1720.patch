From 395bd1f6d3edc9f7edb5d1f2d7deaf5a9e3ab93c Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sat, 14 May 2022 21:29:44 +0100
Subject: [PATCH] patch 8.2.4956: reading past end of line with "gf" in Visual
 block mode

Problem:    Reading past end of line with "gf" in Visual block mode.
Solution:   Do not include the NUL in the length.
---
 src/normal.c            | 13 ++++++++++---
 src/testdir/test_gf.vim | 15 +++++++++++++++
 src/version.c           |  2 ++
 3 files changed, 27 insertions(+), 3 deletions(-)

--- vim-8.1.2269.orig/src/normal.c
+++ vim-8.1.2269/src/normal.c
@@ -3775,9 +3775,15 @@ get_visual_text(
 	    *pp = ml_get_pos(&VIsual);
 	    *lenp = curwin->w_cursor.col - VIsual.col + 1;
 	}
-	if (has_mbyte)
-	    /* Correct the length to include the whole last character. */
-	    *lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
+        if (*lenp > 0)
+        {
+	    if (has_mbyte)
+	        /* Correct the length to include the whole last character. */
+	        *lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
+            else if ((*pp)[*lenp - 1] == NUL)
+                // Do not include a trailing NUL.
+                *lenp -= 1;
+        }
     }
     reset_VIsual_and_resel();
     return OK;
