From a6f9e300161f4cb54713da22f65b261595e8e614 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 28 Jul 2022 21:51:37 +0100
Subject: [PATCH] patch 9.0.0102: reading past end of line with insert mode
 completion

Problem:    Reading past end of line with insert mode completion.
Solution:   Check text length.
---
 src/insexpand.c                   | 2 +-
 src/testdir/test_ins_complete.vim | 8 ++++++++
 src/version.c                     | 2 ++
 3 files changed, 11 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/insexpand.c
+++ vim-8.1.2269/src/insexpand.c
@@ -2924,7 +2924,7 @@ ins_compl_get_exp(pos_T *ini)
 		{
 		    char_u	*tmp_ptr = ptr;
 
-		    if (compl_cont_status & CONT_ADDING)
+		    if ((compl_cont_status & CONT_ADDING) && compl_length <= (int)STRLEN(tmp_ptr))
 		    {
 			tmp_ptr += compl_length;
 			// Skip if already inside a word.
--- vim-8.1.2269.orig/src/testdir/test_ins_complete.vim
+++ vim-8.1.2269/src/testdir/test_ins_complete.vim
@@ -380,3 +380,11 @@ func Test_ins_completeslash()
   set completeslash=
 endfunc
 
+func Test_ins_complete_end_of_line()
+  " this was reading past the end of the line
+  new  
+  norm 8oý 
+  sil! norm o
+
+  bwipe!
+endfunc
