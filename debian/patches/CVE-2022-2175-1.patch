From 6046aded8da002b08d380db29de2ba0268b6616e Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 22 Jun 2022 13:51:54 +0100
Subject: [PATCH] patch 8.2.5148: invalid memory access when using expression
 on command line

Problem:    Invalid memory access when using an expression on the command line.
Solution:   Make sure the position does not go negative.

--- vim-8.1.2269.orig/src/ex_getln.c
+++ vim-8.1.2269/src/ex_getln.c
@@ -785,6 +785,7 @@ getcmdline_int(
     int		init_ccline)	// clear ccline first
 {
     int		c;
+    int		save_new_cmdpos = new_cmdpos;
     int		i;
     int		j;
     int		gotesc = FALSE;		/* TRUE when <ESC> just typed */
@@ -1753,8 +1754,6 @@ getcmdline_int(
 #ifdef FEAT_EVAL
 		/*
 		 * Insert the result of an expression.
-		 * Need to save the current command line, to be able to enter
-		 * a new one...
 		 */
 		new_cmdpos = -1;
 		if (c == '=')
@@ -1795,6 +1794,7 @@ getcmdline_int(
 		    }
 #endif
 		}
+		new_cmdpos = save_new_cmdpos;
 		redrawcmd();
 		goto cmdline_changed;
 
