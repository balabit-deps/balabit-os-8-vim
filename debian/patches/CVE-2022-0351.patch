From: Markus Koschany <apo@debian.org>
Date: Sun, 15 May 2022 15:38:41 +0200
Subject: CVE-2022-0351

Origin: https://github.com/vim/vim/commit/fe6fb267e6ee5c5da2f41889e4e0e0ac5bf4b89d
---
 src/eval.c               | 10 ++++++++++
 src/testdir/test_CVE.vim |  5 +++++
 2 files changed, 15 insertions(+)

--- vim-8.1.2269.orig/src/eval.c
+++ vim-8.1.2269/src/eval.c
@@ -2495,6 +2495,7 @@ eval7(
     char_u	*start_leader, *end_leader;
     int		ret = OK;
     char_u	*alias;
+    static         int recurse = 0;
 
     /*
      * Initialise variable so that clear_tv() can't mistake this for a
@@ -2520,6 +2521,15 @@ eval7(
 	++*arg;
 	return FAIL;
     }
+    
+    // Limit recursion to 1000 levels.  At least at 10000 we run out of stack
+    // and crash.
+    if (recurse == 1000)
+    {
+	
+	return FAIL;
+    }
+    ++recurse;
 
     switch (**arg)
     {
@@ -2761,6 +2771,8 @@ eval7(
      */
     if (ret == OK && evaluate && end_leader > start_leader)
 	ret = eval7_leader(rettv, start_leader, &end_leader);
+
+    --recurse;
     return ret;
 }
 
