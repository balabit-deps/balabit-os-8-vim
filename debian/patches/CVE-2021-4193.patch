From: Markus Koschany <apo@debian.org>
Date: Sun, 27 Feb 2022 17:05:16 +0100
Subject: CVE-2021-4193

Origin: https://github.com/vim/vim/commit/94f3192b03ed27474db80b4d3a409e107140738b
---
 src/charset.c            | 12 +++++++++++-
 src/testdir/test_CVE.vim |  9 +++++++++
 2 files changed, 20 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/charset.c
+++ vim-8.1.2269/src/charset.c
@@ -1224,10 +1224,15 @@ getvcol(
 	posptr = NULL;  /* continue until the NUL */
     else
     {
-	/* Special check for an empty line, which can happen on exit, when
-	 * ml_get_buf() always returns an empty string. */
-	if (*ptr == NUL)
-	    pos->col = 0;
+	colnr_T i;
+
+	// In a few cases the position can be beyond the end of the line.
+	for (i = 0; i < pos->col; ++i)
+	    if (ptr[i] == NUL)
+	    {
+		pos->col = i;
+		break;
+	    }
 	posptr = ptr + pos->col;
 	if (has_mbyte)
 	    /* always start on the first byte */
