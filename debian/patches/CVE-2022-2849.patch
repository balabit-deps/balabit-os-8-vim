From f6d39c31d2177549a986d170e192d8351bd571e2 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 16 Aug 2022 17:50:38 +0100
Subject: [PATCH] patch 9.0.0220: invalid memory access with for loop over NULL
 string

Problem:    Invalid memory access with for loop over NULL string.
Solution:   Make sure mb_ptr2len() consistently returns zero for NUL.
---
 src/globals.h                   |  3 ++-
 src/mbyte.c                     | 21 +++++++++++++--------
 src/testdir/test_eval_stuff.vim | 12 ++++++++++++
 src/version.c                   |  2 ++
 4 files changed, 29 insertions(+), 9 deletions(-)

--- vim-8.1.2269.orig/src/mbyte.c
+++ vim-8.1.2269/src/mbyte.c
@@ -1122,7 +1122,7 @@ dbcs_char2bytes(int c, char_u *buf)
     int
 latin_ptr2len(char_u *p)
 {
- return MB_BYTE2LEN(*p);
+ return *p == NUL ? 0 : 1;
 }
 
     static int
@@ -1130,6 +1130,8 @@ dbcs_ptr2len(
     char_u	*p)
 {
     int		len;
+    if (*p == NUL)
+	return 0;
 
     /* Check if second byte is not missing. */
     len = MB_BYTE2LEN(*p);
