Backport:

Tests intended for test_substitute.vim included in test_CVE.vim.

Simplified change to src/proto/ex_getln.pro due to differences with the
currect version.

Change to use text_or_buf_locked() in window.c has been dropped since
we need the potential call to curbuf_locked() to continue to be 
preceded by #ifdef FEAT_AUTOCMD in this version of vim.

Dropping Test_sub_open_cmdline_win() test due to invalid expression causing
build failure.

---

From 71223e2db87c2bf3b09aecb46266b56cda26191d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 30 May 2022 15:23:09 +0100
Subject: [PATCH] patch 8.2.5043: can open a cmdline window from a substitute
 expression

Problem:    Can open a cmdline window from a substitute expression.
Solution:   Disallow opening a command line window when text or buffer is
            locked.

---

--- vim-8.1.2269.orig/src/buffer.c
+++ vim-8.1.2269/src/buffer.c
@@ -2322,12 +2322,7 @@ buflist_getfile(
     if (buf == curbuf)
 	return OK;
 
-    if (text_locked())
-    {
-	text_locked_msg();
-	return FAIL;
-    }
-    if (curbuf_locked())
+    if (text_or_buf_locked())
 	return FAIL;
 
     /* altfpos may be changed by getfile(), get it now */
--- vim-8.1.2269.orig/src/ex_getln.c
+++ vim-8.1.2269/src/ex_getln.c
@@ -2498,6 +2498,21 @@ get_text_locked_msg(void)
 }
 
 /*
+ * Check for text, window or buffer locked.
+ * Give an error message and return TRUE if something is locked.
+ */
+    int
+text_or_buf_locked(void)
+{
+    if (text_locked())
+    {
+	text_locked_msg();
+	return TRUE;
+    }
+    return curbuf_locked();
+}
+
+/*
  * Check if "curbuf_lock" or "allbuf_lock" is set and return TRUE when it is
  * and give an error message.
  */
@@ -4059,6 +4074,12 @@ open_cmdwin(void)
     int			save_KeyTyped;
 #endif
 
+    // Can't do this when text or buffer is locked.
+#ifdef FEAT_AUTOCMD
+    if (text_or_buf_locked())
+	return K_IGNORE;
+#endif
+
     /* Can't do this recursively.  Can't do it when typing a password. */
     if (cmdwin_type != 0
 # if defined(FEAT_CRYPT) || defined(FEAT_EVAL)
--- vim-8.1.2269.orig/src/proto/ex_getln.pro
+++ vim-8.1.2269/src/proto/ex_getln.pro
@@ -5,6 +5,7 @@ char_u *getcmdline_prompt(int firstc, ch
 int text_locked(void);
 void text_locked_msg(void);
 char *get_text_locked_msg(void);
+int text_or_buf_locked(void);
 int curbuf_locked(void);
 int allbuf_locked(void);
 char_u *getexline(int c, void *cookie, int indent, int do_concat);
