From cdef1cefa2a440911c727558562f83ed9b00e16b Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 20 Oct 2022 14:17:18 +0100
Subject: [PATCH] patch 9.0.0804: crash when trying to divide a number by -1

Problem:    Crash when trying to divice the largest negative number by -1.
Solution:   Handle this case specifically.
---
 src/eval.c                | 8 +++++++-
 src/testdir/test_expr.vim | 6 ++++++
 src/version.c             | 2 ++
 3 files changed, 15 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/eval.c
+++ vim-8.1.2269/src/eval.c
@@ -84,6 +84,12 @@ num_divide(varnumber_T n1, varnumber_T n
 	else
 	    result = VARNUM_MAX;
     }
+    else if (n1 == VARNUM_MIN && n2 == -1)
+    {
+	// specific case: trying to do VARNUM_MIN / -1 results in a positive
+	// number that doesn't fit in varnumber_T and causes an FPE
+	result = VARNUM_MAX;
+    }
     else
 	result = n1 / n2;
 
--- vim-8.1.2269.orig/src/testdir/test_expr.vim
+++ vim-8.1.2269/src/testdir/test_expr.vim
@@ -526,3 +526,9 @@ func Test_broken_number()
   call assert_equal(2, str2nr('2a'))
   call assert_fails('inoremap <Char-0b1z> b', 'E474:')
 endfunc
+
+func Test_divide_by_zero()
+  " only tests that this doesn't crash, the result is not important
+  echo 0 / 0
+  echo 0 / 0 / -1
+endfunc
