From 7c824682d2028432ee082703ef0ab399867a089b Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sun, 8 May 2022 22:32:58 +0100
Subject: [PATCH] patch 8.2.4919: can add invalid bytes with :spellgood

Problem:    Can add invalid bytes with :spellgood.
Solution:   Check for a valid word string.
---
 src/errors.h                    |  4 ++++
 src/mbyte.c                     |  2 +-
 src/spellfile.c                 | 10 ++++++++++
 src/testdir/test_spell_utf8.vim |  5 +++++
 src/version.c                   |  2 ++
 5 files changed, 22 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/mbyte.c
+++ vim-8.1.2269/src/mbyte.c
@@ -4046,7 +4046,7 @@ theend:
     convert_setup(&vimconv, NULL, NULL);
 }
 
-#if defined(FEAT_GUI_GTK) || defined(PROTO)
+#if defined(FEAT_GUI_GTK) || defined(FEAT_SPELL) || defined(PROTO)
 /*
  * Return TRUE if string "s" is a valid utf-8 string.
  * When "end" is NULL stop at the first NUL.
--- vim-8.1.2269.orig/src/spellfile.c
+++ vim-8.1.2269/src/spellfile.c
@@ -4366,6 +4366,10 @@ store_word(
     int		res = OK;
     char_u	*p;
 
+    // Avoid adding illegal bytes to the word tree.
+    if (enc_utf8 && !utf_valid_string(word, NULL))
+	return FAIL;
+
     (void)spell_casefold(word, len, foldword, MAXWLEN);
     for (p = pfxlist; res == OK; ++p)
     {
@@ -6168,6 +6172,12 @@ spell_add_word(
     int		i;
     char_u	*spf;
 
+    if (enc_utf8 && !utf_valid_string(word, NULL))
+    {
+	emsg(_("E1280: Illegal character in word"));
+	return;
+    }
+
     if (idx == 0)	    /* use internal wordlist */
     {
 	if (int_wordlist == NULL)
