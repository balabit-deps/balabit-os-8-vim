Backport of:

From: Markus Koschany <apo@debian.org>
Date: Fri, 4 Mar 2022 20:33:12 +0100
Subject: CVE-2022-0554

Origin: https://github.com/vim/vim/commit/e3537aec2f8d6470010547af28dcbd83d41461b8
---
 src/buffer.c                  | 26 ++++++++++++++++++++++----
 src/testdir/test_quickfix.vim |  3 +--
 2 files changed, 23 insertions(+), 6 deletions(-)

--- vim-8.1.2269.orig/src/buffer.c
+++ vim-8.1.2269/src/buffer.c
@@ -1511,8 +1511,14 @@ do_buffer(
 		buf = buflist_findnr(curwin->w_jumplist[jumpidx].fmark.fnum);
 		if (buf != NULL)
 		{
-		    if (buf == curbuf || !buf->b_p_bl)
-			buf = NULL;	/* skip current and unlisted bufs */
+		    /* Skip current and unlisted bufs.  Also skip a quickfix
+		     * buffer, it might be deleted soon. */
+		    if (buf == curbuf || !buf->b_p_bl
+#if defined(FEAT_QUICKFIX)
+			    || bt_quickfix(buf)
+#endif
+			    )
+			buf = NULL;
 		    else if (buf->b_ml.ml_mfp == NULL)
 		    {
 			/* skip unloaded buf, but may keep it for later */
@@ -1549,7 +1555,11 @@ do_buffer(
 		    continue;
 		}
 		/* in non-help buffer, try to skip help buffers, and vv */
-		if (buf->b_help == curbuf->b_help && buf->b_p_bl)
+		if (buf->b_help == curbuf->b_help && buf->b_p_bl
+#if defined(FEAT_QUICKFIX)
+			    && !bt_quickfix(buf)
+#endif
+			   )
 		{
 		    if (buf->b_ml.ml_mfp != NULL)   /* found loaded buffer */
 			break;
@@ -1567,7 +1577,11 @@ do_buffer(
 	if (buf == NULL)	/* No loaded buffer, find listed one */
 	{
 	    FOR_ALL_BUFFERS(buf)
-		if (buf->b_p_bl && buf != curbuf)
+		if (buf->b_p_bl && buf != curbuf
+#if defined(FEAT_QUICKFIX)
+			    && !bt_quickfix(buf)
+#endif
+		       )
 		    break;
 	}
 	if (buf == NULL)	/* Still no buffer, just take one */
@@ -1576,6 +1590,10 @@ do_buffer(
 		buf = curbuf->b_next;
 	    else
 		buf = curbuf->b_prev;
+#if defined(FEAT_QUICKFIX)
+	    if (bt_quickfix(buf))
+		buf = NULL;
+#endif
 	}
     }
 
