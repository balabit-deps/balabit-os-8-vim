From c99cbf8f289bdda5d4a77d7ec415850a520330ba Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sat, 4 Mar 2023 14:13:10 +0000
Subject: [PATCH] patch 9.0.1378: illegal memory access when using virtual
 editing

Problem:    Illegal memory access when using virtual editing.
Solution:   Make sure "startspaces" is not negative.
---
 src/register.c                   |  2 ++
 src/testdir/test_virtualedit.vim | 10 ++++++++++
 src/version.c                    |  2 ++
 3 files changed, 14 insertions(+)

--- vim-8.1.2269.orig/src/register.c
+++ vim-8.1.2269/src/register.c
@@ -1188,6 +1188,8 @@ op_yank(oparg_T *oap, int deleting, int
 				// double-count it.
 				bd.startspaces = (ce - cs + 1)
 							  - oap->start.coladd;
+				if (bd.startspaces < 0)
+				    bd.startspaces = 0;
 				startcol++;
 			    }
 			}
--- vim-8.1.2269.orig/src/testdir/test_virtualedit.vim
+++ vim-8.1.2269/src/testdir/test_virtualedit.vim
@@ -82,3 +82,13 @@ func Test_edit_change()
   call assert_equal('x', getline(1))
   bwipe!
 endfunc
+
+func Test_edit_special_char()
+  new
+  se ve=all
+  norm a␖0
+  sil! exe "norm o00000\<Nul>k<a0s"
+
+  bwipe!
+  set virtualedit=
+endfunc
