From ef976323e770315b5fca544efb6b2faa25674d15 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 28 Sep 2022 11:48:30 +0100
Subject: [PATCH] patch 9.0.0614: SpellFileMissing autocmd may delete buffer

Problem:    SpellFileMissing autocmd may delete buffer.
Solution:   Disallow deleting the current buffer to avoid using freed memory.
---
 src/buffer.c                 |  7 ++++++-
 src/spell.c                  |  6 ++++++
 src/testdir/test_autocmd.vim | 10 ++++++++++
 src/version.c                |  2 ++
 4 files changed, 24 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/spell.c
+++ vim-8.1.2269/src/spell.c
@@ -1535,6 +1535,10 @@ spell_load_lang(char_u *lang)
     sl.sl_slang = NULL;
     sl.sl_nobreak = FALSE;
 
+    // Disallow deleting the current buffer.  Autocommands can do weird things
+    // and cause "lang" to be freed.
+    ++curbuf->b_locked;
+
     /* We may retry when no spell file is found for the language, an
      * autocommand may load it then. */
     for (round = 1; round <= 2; ++round)
@@ -1588,6 +1592,8 @@ spell_load_lang(char_u *lang)
 	STRCPY(fname_enc + STRLEN(fname_enc) - 3, "add.spl");
 	do_in_runtimepath(fname_enc, DIP_ALL, spell_load_cb, &sl);
     }
+
+    --curbuf->b_locked;
 }
 
 /*
--- vim-8.1.2269.orig/src/testdir/test_autocmd.vim
+++ vim-8.1.2269/src/testdir/test_autocmd.vim
@@ -2296,3 +2296,13 @@ func Test_autocmd_was_using_freed_memory
   split
   au! WinEnter
 endfunc
+
+" this was wiping out the current buffer and using freed memory
+func Test_SpellFileMissing_bwipe()
+  next 0
+  au SpellFileMissing 0 bwipe
+  call assert_fails('set spell spelllang=0', 'E937:')
+
+  au! SpellFileMissing
+  bwipe
+endfunc
