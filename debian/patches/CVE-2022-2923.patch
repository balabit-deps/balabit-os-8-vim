From 6669de1b235843968e88844ca6d3c8dec4b01a9e Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sun, 21 Aug 2022 20:33:47 +0100
Subject: [PATCH] patch 9.0.0240: crash when using ":mkspell" with an empty
 .dic file

Problem:    Crash when using ":mkspell" with an empty .dic file.
Solution:   Check for an empty word tree.
---
 src/spellfile.c                |  4 +++-
 src/testdir/test_spellfile.vim | 12 ++++++++++++
 src/version.c                  |  2 ++
 3 files changed, 17 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/spellfile.c
+++ vim-8.1.2269/src/spellfile.c
@@ -5545,10 +5545,12 @@ sug_filltree(spellinfo_T *spin, slang_T
 
     /*
      * Go through the whole case-folded tree, soundfold each word and put it
-     * in the trie.
+     * in the trie.  Bail out if the tree is empty.
      */
     byts = slang->sl_fbyts;
     idxs = slang->sl_fidxs;
+    if (byts == NULL || idxs == NULL)
+	return FAIL;
 
     arridx[0] = 0;
     curi[0] = 1;
--- vim-8.1.2269.orig/src/testdir/test_spellfile.vim
+++ vim-8.1.2269/src/testdir/test_spellfile.vim
@@ -170,3 +170,13 @@ func Test_spell_normal()
   set spellfile=
   bw!
 endfunc
+
+func Test_mkspell_empty_dic()
+  call writefile(['1'], 'XtestEmpty.dic')
+  call writefile(['SOFOFROM abcd', 'SOFOTO ABCD', 'SAL CIA X'], 'XtestEmpty.aff')
+  mkspell! XtestEmpty.spl XtestEmpty
+
+  call delete('XtestEmpty.dic')
+  call delete('XtestEmpty.aff')
+  call delete('XtestEmpty.spl')
+endfunc
