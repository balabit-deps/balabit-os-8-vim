From dc5490e2cbc8c16022a23b449b48c1bd0083f366 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 25 Jan 2022 13:52:53 +0000
Subject: [PATCH] patch 8.2.4215: illegal memory access when copying lines in
 Visual mode

Problem:    Illegal memory access when copying lines in Visual mode.
Solution:   Adjust the Visual position after copying lines.
---
 src/ex_cmds.c               |  2 ++
 src/testdir/test_visual.vim | 11 +++++++++++
 src/version.c               |  2 ++
 3 files changed, 15 insertions(+)

--- vim-8.1.2269.orig/src/ex_cmds.c
+++ vim-8.1.2269/src/ex_cmds.c
@@ -854,6 +854,8 @@ ex_copy(linenr_T line1, linenr_T line2,
     }
 
     appended_lines_mark(n, count);
+    if (VIsual_active)
+	check_pos(curbuf, &VIsual);
 
     msgmore((long)count);
 }
--- vim-8.1.2269.orig/src/testdir/test_visual.vim
+++ vim-8.1.2269/src/testdir/test_visual.vim
@@ -466,3 +466,14 @@ func Test_visual_exchange_windows()
   bwipe!
   bwipe!
 endfunc
+
+" this was leaving the end of the Visual area beyond the end of a line
+func Test_visual_ex_copy_line()
+  new
+  call setline(1, ["aaa", "bbbbbbbbbxbb"])
+  /x
+  exe "normal ggvjfxO"
+  t0
+  normal gNU
+  bwipe!
+endfunc
