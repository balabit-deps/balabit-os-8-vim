From 6f98371532fcff911b462d51bc64f2ce8a6ae682 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 24 Dec 2021 18:11:27 +0000
Subject: [PATCH] patch 8.2.3884: crash when clearing the argument list while
 using it

Problem:    Crash when clearing the argument list while using it.
Solution:   Lock the argument list for ":all".
---
 src/arglist.c                | 3 +++
 src/testdir/test_arglist.vim | 7 +++++++
 src/version.c                | 2 ++
 3 files changed, 12 insertions(+)

--- vim-8.1.2269.orig/src/arglist.c
+++ vim-8.1.2269/src/arglist.c
@@ -17,6 +17,10 @@
 #define AL_ADD	2
 #define AL_DEL	3
 
+// This flag is set whenever the argument list is being changed and calling a
+// function that might trigger an autocommand.
+static int arglist_locked = FALSE;
+
 /*
  * Clear an argument list: free all file names and reset it to zero entries.
  */
@@ -874,6 +878,7 @@ do_arg_all(
     tabpage_T	*old_curtab, *last_curtab;
     win_T	*new_curwin = NULL;
     tabpage_T	*new_curtab = NULL;
+    int		prev_arglist_locked = arglist_locked;
 
     if (ARGCOUNT <= 0)
     {
@@ -893,6 +898,7 @@ do_arg_all(
     // watch out for its size to be changed.
     alist = curwin->w_alist;
     ++alist->al_refcount;
+    arglist_locked = TRUE;
 
     old_curwin = curwin;
     old_curtab = curtab;
@@ -1104,6 +1110,7 @@ do_arg_all(
 
     // Remove the "lock" on the argument list.
     alist_unlink(alist);
+    arglist_locked = prev_arglist_locked;
 
     --autocmd_no_enter;
 
