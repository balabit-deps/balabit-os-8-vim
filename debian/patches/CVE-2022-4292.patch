From c3d27ada14acd02db357f2d16347acc22cb17e93 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 14 Nov 2022 20:52:14 +0000
Subject: [PATCH] patch 9.0.0882: using freed memory after SpellFileMissing
 autocmd uses bwipe

Problem:    Using freed memory after SpellFileMissing autocmd uses bwipe.
Solution:   Bail out if the window no longer exists.
---
 src/spell.c                |  4 ++--
 src/testdir/test_spell.vim | 13 +++++++++++++
 src/version.c              |  2 ++
 3 files changed, 17 insertions(+), 2 deletions(-)

--- vim-8.1.2269.orig/src/spell.c
+++ vim-8.1.2269/src/spell.c
@@ -2078,7 +2078,7 @@ did_set_spelllang(win_T *wp)
 		spell_load_lang(lang);
 		/* SpellFileMissing autocommands may do anything, including
 		 * destroying the buffer we are using... */
-		if (!bufref_valid(&bufref))
+		if (!bufref_valid(&bufref) || !win_valid_any_tab(wp))
 		{
 		    ret_msg = N_("E797: SpellFileMissing autocommand deleted buffer");
 		    goto theend;
--- vim-8.1.2269.orig/src/testdir/test_spell.vim
+++ vim-8.1.2269/src/testdir/test_spell.vim
@@ -70,6 +70,19 @@ func Test_z_equal_on_invalid_utf8_word()
   bwipe!
 endfunc
 
+func Test_spell_file_missing_bwipe()
+  " this was using a window that was wiped out in a SpellFileMissing autocmd
+  set spelllang=xy
+  au SpellFileMissing * n0
+  set spell
+  au SpellFileMissing * bw
+  snext somefile
+
+  au! SpellFileMissing
+  bwipe!
+  set nospell spelllang=en
+endfunc
+
 " Test spellbadword() with argument
 func Test_spellbadword()
   set spell
