From 232bdaaca98c34a99ffadf27bf6ee08be6cc8f6a Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 13 Jan 2023 14:17:58 +0000
Subject: [PATCH] patch 9.0.1189: invalid memory access with folding and using
 "L"

Problem:    Invalid memory access with folding and using "L".
Solution:   Prevent the cursor from moving to line zero.
---
 src/normal.c              | 3 ++-
 src/testdir/test_fold.vim | 8 ++++++++
 src/version.c             | 2 ++
 3 files changed, 12 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/normal.c
+++ vim-8.1.2269/src/normal.c
@@ -3826,7 +3826,8 @@ nv_scroll(cmdarg_T *cap)
 		{
 		    (void)hasFolding(curwin->w_cursor.lnum,
 						&curwin->w_cursor.lnum, NULL);
-		    --curwin->w_cursor.lnum;
+		    if (curwin->w_cursor.lnum > curwin->w_topline)
+			--curwin->w_cursor.lnum;
 		}
 	    }
 	    else
--- vim-8.1.2269.orig/src/testdir/test_fold.vim
+++ vim-8.1.2269/src/testdir/test_fold.vim
@@ -769,3 +769,11 @@ func Test_fold_delete_with_marker_and_wh
   set fdm& ww&
   bwipe!
 endfunc
+
+func Test_indent_with_L_command()
+  " The "L" command moved the cursor to line zero, causing the text saved for
+  " undo to use line number -1, which caused trouble for undo later.
+  new
+  sil! norm 8R^M^CV{zf8=Lu
+  bwipe!
+endfunc
