From 060623e4a3bc72b011e7cd92bedb3bfb64e06200 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Tue, 14 Nov 2023 21:33:29 +0100
Subject: [PATCH] patch 9.0.2110: [security]: overflow in ex address parsing

Problem:  [security]: overflow in ex address parsing
Solution: Verify that lnum is positive, before substracting from
          LONG_MAX

[security]: overflow in ex address parsing

When parsing relative ex addresses one may unintentionally cause an
overflow (because LONG_MAX - lnum will overflow for negative addresses).

So verify that lnum is actually positive before doing the overflow
check.

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/ex_docmd.c             | 2 +-
 src/testdir/test_excmd.vim | 4 ++++
 src/version.c              | 2 ++
 3 files changed, 7 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/ex_docmd.c
+++ vim-8.1.2269/src/ex_docmd.c
@@ -3758,7 +3758,14 @@ get_address(
 		if (i == '-')
 		    lnum -= n;
 		else
+		{
+		    if (lnum >= 0 && n >= LONG_MAX - lnum)
+		    {
+			emsg(_("E1247: Line number out of range"));
+			goto error;
+		    }
 		    lnum += n;
+		}
 	    }
 	}
     } while (*cmd == '/' || *cmd == '?');
--- vim-8.1.2269.orig/src/testdir/test_excmd.vim
+++ vim-8.1.2269/src/testdir/test_excmd.vim
@@ -52,3 +52,8 @@ func Test_using_zero_in_range()
   silent!  0;s/\%')
   bwipe!
 endfunc
+
+" catch address lines overflow
+func Test_ex_address_range_overflow()
+  call assert_fails(':--+foobar', 'E492:')
+endfunc
--- vim-8.1.2269.orig/src/version.c
+++ vim-8.1.2269/src/version.c
@@ -1620,6 +1620,8 @@ static int included_patches[] =
 /**/
     1849,
 /**/
+    2110,
+/**/
     5023,
 /**/
     4975,
