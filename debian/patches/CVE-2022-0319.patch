From 05b27615481e72e3b338bb12990fb3e0c2ecc2a9 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 20 Jan 2022 13:32:50 +0000
Subject: [PATCH] patch 8.2.4154: ml_get error when exchanging windows in
 Visual mode

Problem:    ml_get error when exchanging windows in Visual mode.
Solution:   Correct end of Visual area when entering another buffer.
---
 src/testdir/test_visual.vim | 10 ++++++++++
 src/version.c               |  2 ++
 src/window.c                |  7 ++++++-
 3 files changed, 18 insertions(+), 1 deletion(-)

--- vim-8.1.2269.orig/src/testdir/test_visual.vim
+++ vim-8.1.2269/src/testdir/test_visual.vim
@@ -456,3 +456,13 @@ func Test_visual_block_insert_round_off(
   exe "normal gg0\<C-V>GI" .. repeat('0', 1320) .. "\<Esc>"
   bwipe!
 endfunc
+
+" this was causing an ml_get error
+func Test_visual_exchange_windows()
+  enew!
+  new
+  call setline(1, ['foo', 'bar'])
+  exe "normal G\<C-V>gg\<C-W>\<C-X>OO\<Esc>"
+  bwipe!
+  bwipe!
+endfunc
--- vim-8.1.2269.orig/src/window.c
+++ vim-8.1.2269/src/window.c
@@ -1669,6 +1669,11 @@ win_exchange(long Prenum)
 
     (void)win_comp_pos();		/* recompute window positions */
 
+    if (wp->w_buffer != curbuf)
+	reset_VIsual_and_resel();
+    else if (VIsual_active)
+	wp->w_cursor = curwin->w_cursor;
+
     win_enter(wp, TRUE);
     redraw_all_later(NOT_VALID);
 }
